Немного отрефакторил код, частично отвязал от классов. Но мало. Я пока не очень понимаю, что должно получиться в конце :(